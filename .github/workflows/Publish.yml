name: Publish

on:
  push:
    branches: [main]
    paths-ignore:
      - "**.md"
  pull_request:
    paths:
      - ".github/workflows/Publish.yml"

defaults:
  run:
    shell: bash
jobs:
  publish:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    strategy:
      matrix:
        include:
        - project: JBSnorro
          workflowName: CI
        - project: JBSnorro.Testing
          workflowName: CI (JBSnorro.Testing)
    env:
      CSPROJ_PATH: '${{ matrix.project }}/${{ matrix.project }}.csproj'
      ASSEMBLY_INFO_PATH: '${{ matrix.project }}/Properties/AssemblyInfo.cs'
      LANG: 'C.UTF-8'  # necessary for grep on Windows
    steps:
      - uses: actions/checkout@v3
      - name: Detect if version changed
        run: |
          current_version=$(bash .github/get_current_version.sh '${{ env.CSPROJ_PATH }}' | xargs)
          echo "current_version: \"$current_version\""
          published_version=$(bash .github/get_published_version.sh '${{ matrix.project }}' | xargs)
          echo "published_version: \"$published_version\""

          if [[ "$current_version" == "$published_version" ]]; then
              echo "Up-to-date"
          else
              echo "PUBLISH=true" >> $GITHUB_ENV
              echo "NEW_VERSION=$current_version" >> $GITHUB_ENV
              echo "Publishing"
          fi


      - name: Setup .NET Core
        if: ${{ env.PUBLISH == 'true' }}
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Create temp Package Source
        if: ${{ env.PUBLISH == 'true' }}
        run: |
          TempPackageSource="$(mktemp -d)"
          echo "TempPackageSource=$TempPackageSource" >> $GITHUB_ENV
          dotnet nuget add source "$TempPackageSource"
      
      - name: Publish to local Package Source (such that `dotnet build` can resolve latest package versions)
        if: ${{ env.PUBLISH == 'true' }}
        run: dotnet publish JBSnorro/JBSnorro.csproj --configuration Release --framework net7.0 --output "$TempPackageSource"

      - name: Build
        if: ${{ env.PUBLISH == 'true' }}
        run: dotnet build --configuration Release

      - name: Wait for CI
        uses: deepinsight-io/action-wait-on-workflow@v2.1.1
        if: ${{ env.PUBLISH == 'true' }}
        with:
          workflowName: ${{ matrix.workflowName }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish
        if: ${{ env.PUBLISH == 'true' && github.ref == 'refs/heads/main' }}
        run: dotnet nuget push "./JBSnorro/bin/Release/JBSnorro.*.symbols.nupkg" -k '${{ secrets.NUGET_API_KEY }}' -s 'https://api.nuget.org/v3/index.json'
